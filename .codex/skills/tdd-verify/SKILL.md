---
name: tdd-verify
description: TDDのVerifyフェーズを実行するためのスキル。モック/スタブ除去や実物差し替え、故意の改変によるテスト健全性確認などで、GREENが「仕様を満たした実装」であることを検証する。モック追加・I/O境界・大きな実装修正直後などVerifyトリガーが立ったときに必ず使う。
---

# tdd-verify（検証：テストが実装を正しく担保しているか確認する）

> **遵守リマインド**: VERIFYを始めるたびに、このSKILL.mdを開いて内容を再確認すること。

## このスキルの目的

- GREENが「テストを騙しただけ」ではなく、仕様を実装で満たしていると証明する。
- モック/スタブ依存を最小化し、実物でも同じシナリオが通ることを確認する。
- テストが壊れた実装を検知できるか（故意改変テスト）を確かめる。

## トリガー（1つでも該当すれば実行）

- 新規/変更したモック・スタブ・フェイクがある。
- I/O境界（DB/HTTP/FS/時計/乱数/Unity/VR等）に触れた。
- 実装差分が大きいのに受入れ観点のテスト増分が薄い。
- 複雑な状態遷移や並行処理を扱うテストを追加・変更した。

## 前提（満たさない場合は停止）

- 直前のGREENで全テストが通っている。
- 対象Spec-IDと関係するテストが特定できている。
- 実物置き換えに必要な依存（実サーバのURL、実ファイルパス等）の扱いが合意済み、または安全にシミュレート可能。

## 入力として集める情報

- 対象SpecのパスとSpec-ID。
- どのモック/スタブ/フェイクを外すか、その代替（実物 or 契約テスト）。
- テスト実行コマンド（統合/契約/シナリオ）。

## 手順（厳守）

1. **フェーズ宣言**
   - 返答冒頭に `Current Phase: VERIFY` を明記。
2. **対象とゴールを固定**
   - Spec-IDと検証したいシナリオを1〜2個に絞り、どのテスト/モックに触るかを書き出す。
3. **モック/スタブを実物へ差し替え**
   - 可能な範囲で実際のI/Oや実装に切り替え、同じテストまたは近似シナリオを実行。
   - 実物が用意できない場合は、契約テストやエンドツーエンドで代替し、理由を記録。
4. **故意改変テスト（テスト健全性チェック）**
   - 主要関数や条件を意図的に壊す（例: 定数返し、条件反転、早期return）パッチを一時適用し、テストが確実にREDになることを確認。
   - REDが再現しない場合はテスト不足として補強する。
5. **元に戻して全テスト再実行**
   - 改変を元に戻し、全テスト/対象テストを実行してGREEN維持を確認。
6. **残すモックの正当化**
   - 外せなかったモックごとに「なぜ残すか」と「実物での担保策（契約/統合テスト）」を明記し、必要ならTODO化。

## ガードレール（やってはいけない）

- Verifyを省略して次フェーズへ進まない。
- 故意改変を入れたまま差分を残さない（必ず元に戻す）。
- 実環境を使う場合、データ破壊や秘匿情報漏洩に注意し、安全なデータ/設定でのみ実行する。
- 振る舞い変更が必要と判明した場合、Spec更新→REDからやり直す。

## 出力フォーマット（返答はこれに従う）

1. `Current Phase: VERIFY`
2. `対象Spec:`（パス + Spec-ID）
3. `検証範囲:`（モック/スタブ/境界/シナリオの特定）
4. `実物差し替え/契約テスト:`（実施内容と結果の要約）
5. `故意改変テスト:`（どこを壊したか + REDの確認結果）
6. `実行コマンド:`（実際に走らせたコマンド）
7. `結果:`（GREEN確認/残課題。モックを残す理由と代替担保）
8. `次:`（Refactorに渡すTODOまたは次のRED候補を1つ）
