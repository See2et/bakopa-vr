# テスト用participant_idオーバーライドの注入

作成日: 2025-12-01
対象: bloom-ws WebSocketサーバ（参加者ID決定）

## 目的

テストからWebSocket接続に用いる `participant_id` を決定論的に指定できるようにし、環境変数依存を排除する。

## 背景

現行テストは `BLOOM_TEST_PARTICIPANT_ID` 環境変数で接続ごとの `participant_id` を上書きしている。環境変数操作は並列テストで競合しやすく、グローバル状態汚染のリスクがある。テスト専用の設定注入経路を設け、各接続で安全に固定IDを与えたい。

## 振る舞い

- サーバ起動時に `TestOverrides`（名称は暫定）で `participant_id` オーバーライドを渡せる。
- オーバーライドは「接続ごとに現在の値を問い合わせ、`Some(id)` ならそれを採用、`None` なら従来のランダム生成 `ParticipantId::new()`」という決定を行う。
- 既存の `start_ws_server` はデフォルトオーバーライド（常に `None` を返す）で動作し、外部APIの挙動は変わらない。
- オーバーライドの供給はスレッドセーフで、テストから値を変更すれば後続接続で反映される。

## テスト観点（本サイクルでカバー）

- 重複接続テスト: オーバーライドで同一 `participant_id` を返すと、従来どおり旧接続がCloseされ、新接続は維持される。
- ブロードキャスト登録テスト: オーバーライドを解除（`None` に切替）した後の新規参加者は固有IDとなり、オーナー接続がブロードキャストを受け取る。
- 回帰防止: オーバーライド未指定時（デフォルト）はこれまでと同じくランダムIDが割り当てられる。

## 非スコープ

- 本番設定から任意IDを注入する機能は提供しない（テスト用途限定）。
- 参加者ID生成ロジック自体のリプレイ性・連番化などの拡張は行わない。
