name: cc-sdd-impl-codex
description: cc-sdd implementation automation for Codex (plan -> implement batch -> validate -> commit -> loop until complete)
max_iterations: 80
initial_movement: plan
movements:
  - name: plan
    edit: false
    provider: codex
    persona: |
      あなたは cc-sdd の実装フェーズを管理するテクニカルプランナーです。
      目的は docs/specs の既存仕様に従い、実装対象を安全に特定して次ステップへ渡すことです。
    allowed_tools:
      - Read
      - Glob
      - Grep
      - Bash
    instruction_template: |
      与えられた task 文字列を解析して、実装対象を特定してください。

      想定フォーマット:
      feature=<spec-directory-name>
      tasks=auto|1.1,1.2
      batch_size=1..3
      必須要件:
      1. feature を抽出し、`docs/specs/<feature>/spec.json` が存在することを確認する
      2. tasks 未指定時は auto として扱う
      3. batch_size 未指定時は 2 として扱う（範囲外は 2 に補正）
      4. 実行開始前に spec.json の approvals.tasks.approved と ready_for_implementation を確認する
      5. 以降の movement が使えるように、feature / tasks / batch_size / approval 状態を簡潔に出力する

      解析対象:
      {task}
    rules:
      - condition: 実行対象を特定できて、実装開始可能と判断した
        next: implement_batch
      - condition: 実行対象を特定できない、または実装開始不可と判断した
        next: ABORT
  - name: implement_batch
    edit: true
    provider: codex
    persona: |
      あなたは cc-sdd 実装担当です。
      docs/specs と docs/steering を単一の正として扱い、TDD で小さく安全に進めてください。
    pass_previous_response: true
    allowed_tools:
      - Read
      - Glob
      - Grep
      - Edit
      - Write
      - Bash
      - WebSearch
      - WebFetch
    permission_mode: edit
    instruction_template: |
      直前ステップ出力（plan または validate_impl）を入力として、1バッチ分の実装を行ってください。

      必須実行手順:
      1. `docs/specs/<feature>/spec.json`, `requirements.md`, `design.md`, `tasks.md` と `docs/steering/` 全体を読む
      2. 直前が validate_impl で「追加した修正 task IDs」が提示されている場合は、その IDs をこのバッチの実行対象として最優先する
      3. 2 に該当しない場合、`tasks=auto` は未完了タスク (`- [ ]`) から file order 先頭を batch_size 件選ぶ
      4. 2 に該当しない場合、`tasks` が明示されているときは指定 ID の未完了タスクのみ対象にする
      5. 各タスクを TDD (RED -> GREEN -> REFACTOR) で実装する
      6. 完了したタスクのみ `tasks.md` を `- [x]` に更新する
         - `- [x]` へ更新してよいのは、次の3点を満たすタスクに限る:
           1) 仕様に対応する実装コード差分が存在する
           2) 仕様に対応する自動テスト（新規または更新）が存在し、成功している
           3) 実行時エビデンス（ログ抜粋・スモーク結果・再現手順の確認結果のいずれか）を提示できる
         - 上記3点のいずれかが欠ける場合、そのタスクは `- [ ]` のまま維持する
      7. バッチ完了後に次を実行する:
         - `cargo fmt --all`
         - `cargo clippy --all-targets --all-features -- -D warnings`
         - `cargo test --workspace --all-targets`
         - `if [ -f client/godot/project.godot ]; then bash scripts/check_godot_client_startup.sh; fi`
      8. 実装した task IDs と残件数を要約する

      制約:
      - 仕様書生成（requirements/design/tasks の再生成）は行わない
      - approvals.tasks.approved=false または ready_for_implementation=false の spec は中断する
      - 失敗した品質ゲートがある場合は中断し、失敗コマンドを明示する
      - この movement では git commit を行わない（commit は finalize の規約に従い TAKT 側で実施）

      前ステップ出力:
      {previous_response}
    rules:
      - condition: バッチ実装と品質ゲートが成功した
        next: validate_batch
      - condition: 承認状態または品質ゲートの失敗により続行できない
        next: ABORT
  - name: validate_batch
    edit: false
    provider: codex
    persona: |
      あなたは cc-sdd 実装検証担当です。
      仕様整合性と進捗を判定し、次に進めるかどうかを明確に判断してください。
    pass_previous_response: true
    allowed_tools:
      - Read
      - Glob
      - Grep
      - Bash
    instruction_template: |
      直前バッチの結果を検証し、次の遷移を判定してください。

      必須検証:
      1. `tasks.md` の [x] 更新が実装結果と一致している
      2. 実装内容が requirements/design と矛盾していない
      3. 要件→成果物（コード/テスト/実行時エビデンス）の対応が各 [x] タスクで示されている
      4. 直前 movement の品質ゲート成功結果がある
      5. 未完了タスクの有無を確認する
      6. requirements/design に「Godot 入力収集・配線（WASD/マウス/VR入力）」が含まれる場合、
         対応する成果物として `client/godot/**` の差分（シーン/スクリプト/InputMap のいずれか）が
         存在することを確認する。差分がない場合は検証不一致として implement_batch に戻す

      判定:
      - 検証が通る -> 未完了タスクの有無を明示し、commit_batch へ進める
      - 検証不一致がある -> implement_batch へ戻し修正を要求
      - 致命的矛盾または前提不足 -> ABORT

      前ステップ出力:
      {previous_response}
    rules:
      - condition: 検証成功
        next: commit_batch
      - condition: 修正可能な不整合を検出した
        next: implement_batch
      - condition: 致命的矛盾または前提不足を検出した
        next: ABORT
  - name: commit_batch
    edit: false
    provider: codex
    persona: |
      あなたは cc-sdd のコミット担当です。
      1バッチ分の変更を小さくコミットし、未完了があれば次サイクルへ戻してください。
    pass_previous_response: true
    allowed_tools:
      - Read
      - Glob
      - Grep
      - Bash
    instruction_template: |
      直前バッチの実装結果をコミットし、次の遷移を判定してください。

      必須実行手順:
      1. `tasks.md` を確認し、未完了タスクの有無を判断する
      2. 直前バッチの変更だけを `git add -A` でステージする
      3. 変更内容から type/scope/summary を自動決定し、`git -c commit.gpgsign=false commit -m "<type>(<scope>): <summary>"` を実行する

      conventional commit message のルール:
      - 形式: `<type>(<scope>): <summary>`
      - type は `feat|fix|refactor|docs|test|chore|perf|ci|build|revert` のいずれか
      - summary は命令形・72文字以内・末尾ピリオドなし
      - `<scope>` は task の対象領域を示す短い識別子
      - 今回の 1バッチ分の変更だけを説明する

      判定:
      - 未完了タスクあり -> plan へ戻す
      - 未完了タスクなし -> validate_impl へ進める

      前ステップ出力:
      {previous_response}
    rules:
      - condition: 未完了タスクがある
        next: plan
      - condition: 未完了タスクがない
        next: validate_impl

  - name: validate_impl
    edit: true
    provider: codex
    persona: |
      あなたは cc-sdd の最終実装検証担当です。
      すべてのタスク完了後に実装全体の妥当性を確認し、最終報告へ進めるか判定してください。
    pass_previous_response: true
    allowed_tools:
      - Read
      - Glob
      - Grep
      - Edit
      - Write
      - Bash
    permission_mode: edit
    instruction_template: |
      未完了タスクがなくなった後の最終検証を実施してください。

      必須実行手順:
      1. feature を特定し、`tasks.md` の全タスクが完了済み（`- [x]`）であることを確認する
      2. `/prompts:kiro-validate-impl {feature} all-tasks` で実装全体を検証する
      3. 直近バッチまでの品質ゲート結果（fmt/clippy/test/godot-client-startup）が成功していることを確認する
      4. 修正可能な不整合を検出した場合は、対応用タスクを `docs/specs/<feature>/tasks.md` に `- [ ]` で追加する
      5. 4 で追加した場合は、追加した task IDs を明示して次に implement_batch で実行すべき対象として出力する
      6. 検証結果を要約し、次遷移を判定する

      判定:
      - 検証成功 -> finalize へ進める
      - 修正可能な不整合あり -> tasks.md に追記した task IDs とともに implement_batch へ戻す
      - 致命的問題あり -> ABORT

      前ステップ出力:
      {previous_response}
    rules:
      - condition: 最終実装検証が成功した
        next: finalize
      - condition: 修正可能な不整合を検出した
        next: implement_batch
      - condition: 致命的問題を検出した
        next: ABORT

  - name: finalize
    edit: false
    provider: codex
    persona: |
      あなたは完了報告担当です。
      実装完了結果と残課題を短く正確に要約してください。
    pass_previous_response: true
    allowed_tools:
      - Read
      - Glob
      - Grep
      - Bash
    instruction_template: |
      最終結果を以下の形式で報告してください。

      必須実行手順:
      1. 現在ブランチ名を取得し、`takt/pipeline-*` であることを確認する
      2. `git rev-parse --abbrev-ref @{-1}` で直前ブランチ名を取得する
      3. 直前ブランチへ checkout する
      4. `takt/pipeline-*` ブランチを `git merge --no-ff` で直前ブランチへ取り込む
      5. マージ成功後、取り込み元の `takt/pipeline-*` ブランチを削除する
      6. 以下フォーマットで最終報告する（失敗時は失敗理由を明示して ABORT 判定）

      - feature
      - 完了した task IDs
      - 未完了 task IDs（次サイクル対象）
      - 実行した品質ゲート結果（fmt/clippy/test/godot-client-startup）
      - conventional commit message（必須）
      - 既知の残課題（なければ「なし」）
      - 次の推奨アクション（例: PR レビュー）

      conventional commit message のルール:
      - 形式: `<type>(<scope>): <summary>`
      - type は `feat|fix|refactor|docs|test|chore|perf|ci|build|revert` のいずれか
      - summary は命令形・72文字以内・末尾ピリオドなし
      - `<scope>` は task の対象領域を示す短い識別子
      - 今回の 1サイクル分の変更だけを説明する

      前ステップ出力:
      {previous_response}
    rules:
      - condition: 完了報告を作成した
        next: COMPLETE
      - condition: 完了報告を作成できない
        next: ABORT
